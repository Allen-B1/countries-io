<html lang="en">
	<head>
		<title>countries.io</title>
		<link rel="stylesheet" href="/style.css">
		<style>
#error:not(:empty) {
	color: red;
	background: inherit;
	position: fixed;
	top: 0; left: 0; width: 100%; height: 100%;
}
.tile {
	width: 32px;
	height:32px;
	color: #fff;
	text-align: center;
    background: hsl(var(--color), 75%, 65%);
	font-size: 12px;
}
#map, #countries {
	border-collapse: collapse; }
#map {
	background: transparent; }
#countries {
	position: fixed;
	top: 16px; right: 16px;
	background: rgba(250,250,250,0.8);
	color: #000;
	font-size: 14px;
}
body {
	margin: 0; padding: 0;
}
#countries td {
	padding: 8px 12px;
}
.tile[data-terrain="-2"] {
	background: #888;
    color: #fff; }
.tile[data-terrain="-1"] {
    background: transparent;
	color: #111; }
.tile[data-terrain="0"] {
    --color: 0; }
.tile[data-terrain="1"] {
    --color: 200; }
.tile[data-terrain="2"] {
    --color: 100; }
.tile[data-terrain="3"] {
    --color: 35; }
.tile[data-terrain="4"] {
    --color: 70; }
.tile[data-terrain="5"] {
    --color: 300; }
.tile:focus {
	outline: 2px solid hsl(var(--color), 65%, 55%);
}
.capital {
    background: url(/capital.svg) hsl(var(--color), 75%, 65%);
}
.city {
    background: url(/city.svg) hsl(var(--color), 75%, 65%);
}

.country[data-index="0"] {
	color: hsl(0, 75%, 65%); }
.country[data-index="1"] {
	color: hsl(200, 75%, 65%); }
.country[data-index="2"] {
	color: hsl(100, 75%, 65%); }
.country[data-index="3"] {
	color: hsl(35, 75%, 65%); }
.country[data-index="4"] {
	color: hsl(70, 75%, 65%); }
.country[data-index="5"] {
	color: hsl(300, 75%, 65%); }
		</style>
	</head>
	<body>
		<audio src="/sound.wav" autoplay></audio>
		<div id="error"></div>
		<table id="countries"></table>
		<table id="map"></table>
		<script>
var map = null;
var countries = [];
var width, height;
var gameId, countryIndex;

function totalArmy(fCountryIndex) {
	var total = 0;
	for (var i = 0; i < map.terrain.length; i++) {
		if (map.terrain[i] == fCountryIndex) {
			total += map.armies[i];
		}
	}
	return total;
}

var capitalSelected = false;

var ws = new WebSocket((location.protocol == "https:" ? "wss":  "ws") + "://" + location.host + "/ws/game");
ws.onmessage = function(msg) {
	if (msg.data.startsWith("update ")) {
		var data = JSON.parse(msg.data.slice("update ".length));
		map = data;

		for (var i = 0; i < map.terrain.length; i++) {
			var elem = document.getElementById("tile-" + i);
			if (elem != null) {
				elem.setAttribute("data-terrain", map.terrain[i]);
				if (map.terrain[i] == -1 && map.armies[i] == 0) {
					elem.innerHTML = "";
				} else {
					elem.innerHTML = map.armies[i];
				}
			}
		}
        for (var tile of map.capitals) {
			var elem = document.getElementById("tile-" + tile);
            elem.classList.add("capital");
        }
        for (var tile of map.cities) {
			var elem = document.getElementById("tile-" + tile);
            elem.classList.add("city");
        }
        if (!capitalSelected && !(document.activeElement.id && document.activeElement.id.startsWith("tile-"))) {
			for (var capital of map.capitals) {
				if (map.terrain[capital] == countryIndex) {
		            document.getElementById("tile-" + capital).focus();
					capitalSelected = true;
					break;
				}
			}
		}

		for (var i = 0; i < countries.length; i++) {
			var elem = document.getElementById("total-" + i);
			elem.innerHTML = totalArmy(i);
		}

		console.log("update");
	} else if (msg.data.startsWith("map ")) {
		console.log(msg.data);
		width = msg.data.split(" ")[1] | 0;
		height = msg.data.split(" ")[2] | 0;

		var maptable = document.getElementById("map");
		for (let i = 0; i < height; i++) {
			let row = maptable.insertRow(i);
			for (let j = 0; j < width; j++) {
				let cell = row.insertCell(j);
				cell.id = "tile-" + (i * width + j);
				cell.classList.add("tile");
				cell.setAttribute("tabindex", "-1");
				cell.addEventListener("click", function(e) {
					if (map.terrain[this.id.slice(5)] === countryIndex)
						this.focus();
					else
						this.blur();
				});
			}
		}
		maptable.style.width = (32 * width) + "px";
		maptable.style.height = (32 * height) + "px";
	} else if (msg.data.startsWith("player_list ")) {
		console.log(msg.data);
		countries = msg.data.split(" ").slice(1);
		var table = document.getElementById("countries");
		for (let i = 0; i < countries.length; i++) {
			let row = table.insertRow(i);
			let cellname = row.insertCell(0);
			cellname.innerHTML = countries[i];
			cellname.classList.add("country");
			cellname.setAttribute("data-index", i);
			if (i == countryIndex) {
				row.style.fontWeight = "bold";
			}

			let celltotal = row.insertCell(1);
			celltotal.innerHTML = "0";
			celltotal.classList.add("total");
			celltotal.id = "total-" + i;
		}
	} else {
		console.log(msg.data);
	}
}
ws.onopen = function() {
	var arr = location.hash.slice(1).split(":");
	gameId = arr[0], countryIndex = arr[1] | 0;
	ws.send("join " + gameId + " " + countryIndex);
}

window.onkeydown = function(e) {
	if (document.activeElement.id && document.activeElement.id.startsWith("tile-")){
		var index = document.activeElement.id.slice(5) | 0;
        if (e.code == "KeyW" || e.code == "KeyA" || e.code == "KeyS" || e.code == "KeyD") {
            var endIndex;
            switch (e.code) {
            case "KeyA":
                endIndex = index - 1;
                break;
            case "KeyD":
                endIndex = index + 1;
                break;
            case "KeyW":
                endIndex = index - width;
                break;
            case "KeyS":
                endIndex = index + width;
                break;
            default: return;
            }
            ws.send("attack " + index + " " + endIndex);
            var endtile = document.getElementById("tile-" + endIndex);
            if (endtile != null) endtile.focus();
    	}
        if (e.key == "1") {
            ws.send("city " + index);
        }
        if (e.key == "2") {
            ws.send("wall " + index);
        }
    }
}
		</script>
	</body>
</html>

