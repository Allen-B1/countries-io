<html lang="en">
	<head>
		<title>countries.io</title>
		<link rel="stylesheet" href="/style.css">
		<style>
#error:not(:empty) {
	color: red;
	background: inherit;
	position: fixed;
	top: 0; left: 0; width: 100%; height: 100%;
}
.tile {
	width: 32px;
	height:32px;
	color: #fff;
	text-align: center;
    background: hsl(var(--color), 75%, 65%);
	font-size: 12px;
}
#map, #countries {
	border-collapse: collapse; }
#map {
	background: transparent; }
#countries, #turn-container {
	position: fixed;
	top: 16px; right: 16px;
	background: rgba(250,250,250,0.8);
	color: #000;
	font-size: 14px;
}
#turn-container {
	left: 16px; right: auto;
	padding: 8px 12px;
}
body {
	margin: 0; padding: 0;
}
#countries td {
	padding: 8px 12px;
}
.tile[data-terrain="-2"] {
	background: #888;
    color: #fff; }
.tile[data-terrain="-1"] {
    background: transparent;
	color: #111; }
.tile[data-terrain="0"], [data-index="0"] {
    --color: 0; }
.tile[data-terrain="1"], [data-index="1"] {
    --color: 200; }
.tile[data-terrain="2"], [data-index="2"] {
    --color: 100; }
.tile[data-terrain="3"], [data-index="3"] {
    --color: 35; }
.tile[data-terrain="4"], [data-index="4"] {
    --color: 70; }
.tile[data-terrain="5"], [data-index="5"] {
    --color: 300; }
.tile:focus {
	outline: 2px solid hsl(var(--color), 65%, 55%);
}
.tile[data-terrain="-2"]:focus {
	outline: 2px solid #333; }
.tile[data-terrain="-1"]:focus {
	outline: 2px solid #aaa; }
.capital {
    background: url(/capital.svg) hsl(var(--color), 75%, 65%);
}
.city {
    background: url(/city.svg) hsl(var(--color), 75%, 65%);
}
.school {
	color: hsl(var(--color), 55%, 35%);
}

.country {
	color: hsl(var(--color), 75%, 65%);
}
	</style>
	</head>
	<body>
		<audio src="/sound.wav" autoplay></audio>
		<div id="error"></div>
		<div id="turn-container">Turn <span id="turn">0</span></div>
		<table id="countries"></table>
		<table id="map"></table>
		<script>
var map = {
	terrain: [],
	armies: [],
	capitals: [],
	cities: [],
	schools: null
};
var countries = [];
var width, height;
var gameId, countryIndex;

function totalcount(fCountryIndex) {
	var total = 0;
	var totalsci = 0;
	for (var i = 0; i < map.terrain.length; i++) {
		if (map.terrain[i] == fCountryIndex) {
			if (map.schools.has(i)) {
				totalsci += map.armies[i];
			} else {
				total += map.armies[i];
			}
		}
	}
	return [total, totalsci];
}

function patch(old, diff) {
	var out = [];
	var i = 0;
	while (i < diff.length) {
		if (diff[i]) {  // matching
			Array.prototype.push.apply(out, old.slice(out.length, out.length + diff[i]));
		}
		i++;
		if (i < diff.length && diff[i]) {  // mismatching
			Array.prototype.push.apply(out, diff.slice(i + 1, i + 1 + diff[i]));
			i += diff[i];
		}
		i++;
	}
	return out;
}

var capitalSelected = false;
var canAttack = false;

var ws = new WebSocket((location.protocol == "https:" ? "wss":  "ws") + "://" + location.host + "/ws/game");
ws.onmessage = function(msg) {
	console.log("ws: " + msg.data);

	if (msg.data.startsWith("update ")) {
		canAttack = true;
		var data = JSON.parse(msg.data.slice("update ".length));
		document.getElementById("turn").innerHTML = data.turn;
		map.cities = data.cities;
		map.capitals = data.capitals;
		map.schools = new Set(data.schools);
		map.terrain = patch(map.terrain, data.terrain_diff);
		map.armies = patch(map.armies, data.armies_diff);

		for (var i = 0; i < map.terrain.length; i++) {
			var elem = document.getElementById("tile-" + i);
			if (elem != null) {
				elem.setAttribute("data-terrain", map.terrain[i]);
				if (map.terrain[i] == -1 && map.armies[i] == 0) {
					elem.innerHTML = "";
				} else {
					elem.innerHTML = map.armies[i];
				}
				if (map.schools.has(i)) {
					elem.classList.add("school");
				} else if (elem.classList.contains("school")) {
					elem.classList.remove("school");
				}
			}
		}
        for (var tile of map.capitals) {
			var elem = document.getElementById("tile-" + tile);
            elem.classList.add("capital");
        }
        for (var tile of map.cities) {
			var elem = document.getElementById("tile-" + tile);
            elem.classList.add("city");
			if (elem.classList.contains("capital"))
				elem.classList.remove("capital");
        }
        if (!capitalSelected && !(document.activeElement.id && document.activeElement.id.startsWith("tile-"))) {
			for (var capital of map.capitals) {
				if (map.terrain[capital] == countryIndex) {
		            document.getElementById("tile-" + capital).focus();
					capitalSelected = true;
					break;
				}
			}
		}

		for (var i = 0; i < countries.length; i++) {
			var total = totalcount(i);
			document.getElementById("total-" + i).innerHTML = total[0];
			document.getElementById("scientists-" + i).innerHTML = total[1];
		}
	} else if (msg.data.startsWith("map ")) {
		width = msg.data.split(" ")[1] | 0;
		height = msg.data.split(" ")[2] | 0;

		var maptable = document.getElementById("map");
		for (let i = 0; i < height; i++) {
			let row = maptable.insertRow(i);
			for (let j = 0; j < width; j++) {
				let cell = row.insertCell(j);
				cell.id = "tile-" + (i * width + j);
				cell.classList.add("tile");
				cell.setAttribute("tabindex", "-1");
				cell.addEventListener("click", function(e) {
					if (map.terrain[this.id.slice(5)] === countryIndex)
						this.focus();
					else
						this.blur();
				});
			}
		}
		maptable.style.width = (32 * width) + "px";
		maptable.style.height = (32 * height) + "px";
	} else if (msg.data.startsWith("player_list ")) {
		countries = msg.data.split(" ").slice(1);
		var table = document.getElementById("countries");
		for (let i = 0; i < countries.length; i++) {
			let row = table.insertRow(i);
			row.setAttribute("data-index", i);
			row.id = "country-" + i;
			let cellname = row.insertCell(0);
			cellname.innerText = countries[i].replace(/_/g, " ");
			cellname.classList.add("country");
			if (i == countryIndex) {
				row.style.fontWeight = "bold";
			}

			let celltotal = row.insertCell(1);
			celltotal.innerHTML = "0";
			celltotal.classList.add("total");
			celltotal.id = "total-" + i;

			let cellsci = row.insertCell(2);
			cellsci.innerHTML = "0";
			cellsci.id = "scientists-" + i;
		}
	} else if (msg.data.startsWith("player_lose ")) {
		for (var country of msg.data.split(" ").slice(1)) {
			var elem = document.getElementById("country-" + country);
			if (elem !== null)
				elem.style.setProperty("text-decoration", "line-through");
		}
	}
}
ws.onopen = function() {
	var arr = location.hash.slice(1).split(":");
	gameId = arr[0], countryIndex = arr[1] | 0;
	ws.send("join " + gameId + " " + countryIndex);
}

window.onkeydown = function(e) {
	if (document.activeElement.id && document.activeElement.id.startsWith("tile-")){
		var index = document.activeElement.id.slice(5) | 0;
        if (e.code == "KeyW" || e.code == "KeyA" || e.code == "KeyS" || e.code == "KeyD") {
			if (!canAttack || (map.terrain[index] != countryIndex && map.terrain[index] != -2)) return;
            var endIndex;
            switch (e.code) {
            case "KeyA":
                endIndex = index - 1;
                break;
            case "KeyD":
                endIndex = index + 1;
                break;
            case "KeyW":
                endIndex = index - width;
                break;
            case "KeyS":
                endIndex = index + width;
                break;
            default: return;
            }
			if (map.terrain[index] !== -2) {
		        ws.send("attack " + index + " " + endIndex);
				canAttack = false;
			}
            var endtile = document.getElementById("tile-" + endIndex);
            if (endtile != null) endtile.focus();
    	}
        if (e.key == "1") {
            ws.send("city " + index);
        }
        if (e.key == "2") {
            ws.send("wall " + index);
        }
		if (e.key == "3") {
			ws.send("school " + index);
		}
    }
}
		</script>
	</body>
</html>

